{% extends "administrar/base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid px-4 mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary fw-bold mb-0">
                <i class="bi bi-book"></i> Libro Mayor
            </h2>
            <p class="text-muted mb-0">Movimientos detallados por cuenta contable</p>
        </div>
        <div>
            <button class="btn btn-success" id="btnExportarMayor">
                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
            </button>
            <button class="btn btn-primary" id="btnConsultarMayor">
                <i class="bi bi-search"></i> Consultar
            </button>
        </div>
    </div>

    <!-- FILTROS -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">
                        <i class="bi bi-diagram-3"></i> Cuenta Contable *
                    </label>
                    <select class="form-select" id="filtroCuenta" required>
                        <option value="">Seleccione una cuenta...</option>
                        <!-- Se llena dinámicamente -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-range"></i> Ejercicio
                    </label>
                    <select class="form-select" id="filtroEjercicio">
                        <option value="">Todos los ejercicios</option>
                        <!-- Se llena dinámicamente -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Fecha Desde</label>
                    <input type="date" class="form-control" id="filtroFechaDesde">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Fecha Hasta</label>
                    <input type="date" class="form-control" id="filtroFechaHasta">
                </div>
                <div class="col-md-1">
                    <label class="form-label fw-bold d-block">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" id="btnLimpiarFiltros">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- INFORMACIÓN DE LA CUENTA -->
    <div class="card border-0 shadow-sm mb-3" id="infoCuenta" style="display: none;">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="mb-2">
                        <span class="badge bg-primary" id="cuentaCodigo"></span>
                        <span id="cuentaNombre"></span>
                    </h5>
                    <p class="text-muted mb-0">
                        <strong>Tipo:</strong> <span id="cuentaTipo"></span> |
                        <strong>Nivel:</strong> <span id="cuentaNivel"></span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <h6 class="text-muted mb-1">Saldo Actual</h6>
                    <h3 class="mb-0" id="saldoActual">$0.00</h3>
                    <small class="text-muted" id="tipoSaldo"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN DE MOVIMIENTOS -->
    <div class="row g-3 mb-3" id="resumenMayor" style="display: none;">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-2">Saldo Inicial</h6>
                    <h4 class="mb-0" id="saldoInicial">$0.00</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title mb-2">Total Debe</h6>
                    <h4 class="mb-0" id="totalDebe">$0.00</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title mb-2">Total Haber</h6>
                    <h4 class="mb-0" id="totalHaber">$0.00</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title mb-2">Saldo Final</h6>
                    <h4 class="mb-0" id="saldoFinal">$0.00</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DE MOVIMIENTOS -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle" id="tablaMayor">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 10%;">Fecha</th>
                            <th style="width: 8%;">Asiento</th>
                            <th style="width: 42%;">Descripción</th>
                            <th style="width: 12%;" class="text-end">Debe</th>
                            <th style="width: 12%;" class="text-end">Haber</th>
                            <th style="width: 12%;" class="text-end">Saldo</th>
                            <th style="width: 4%;" class="text-center">Ver</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="bi bi-info-circle fs-3 d-block mb-2"></i>
                                Seleccione una cuenta y haga clic en "Consultar"
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- PAGINACIÓN -->
            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top" id="paginacionContainer"
                style="display: none;">
                <div>
                    <span class="text-muted">
                        Mostrando <strong id="rangoInicio">0</strong>-<strong id="rangoFin">0</strong> de <strong
                            id="movimientosTotales">0</strong> movimientos
                    </span>
                    <select class="form-select form-select-sm d-inline-block ms-2" id="itemsPorPagina"
                        style="width: auto;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="text-muted ms-1">por pág.</span>
                </div>
                <div>
                    <nav aria-label="Paginación">
                        <ul class="pagination pagination-sm mb-0" id="paginacion">
                            <!-- Se llena dinámicamente -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL DETALLE ASIENTO -->
<div class="modal fade" id="modalDetalleAsiento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-journal-text me-2"></i>Detalle de Asiento #<span id="modalAsientoNumero"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Info Encabezado -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Fecha:</strong> <span id="modalAsientoFecha"></span></p>
                        <p class="mb-1"><strong>Descripción:</strong> <span id="modalAsientoDesc"></span></p>
                    </div>
                    <div class="col-md-6 text-end">
                        <p class="mb-1"><strong>Origen:</strong> <span class="badge bg-secondary"
                                id="modalAsientoOrigen"></span></p>
                    </div>
                </div>

                <!-- Tabla Detalle -->
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Cuenta</th>
                                <th class="text-end" style="width: 120px;">Debe</th>
                                <th class="text-end" style="width: 120px;">Haber</th>
                            </tr>
                        </thead>
                        <tbody id="modalAsientoItems">
                            <!-- Items dinámicos -->
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td class="text-end">Totales:</td>
                                <td class="text-end text-success" id="modalTotalDebe"></td>
                                <td class="text-end text-danger" id="modalTotalHaber"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa;
    }

    .saldo-positivo {
        color: #198754;
        font-weight: 600;
    }

    .saldo-negativo {
        color: #dc3545;
        font-weight: 600;
    }
</style>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/administrar/mayor.js' %}?v={% now 'U' %}"></script>
{% endblock %}