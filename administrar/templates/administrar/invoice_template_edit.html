<p class="text-muted mb-0">Personalizá el diseño de tus facturas A4.</p>
</div>
<div>
    <button type="submit" form="templateForm" class="btn btn-primary btn-lg shadow-sm">
        <i class="bi bi-save"></i> Guardar Cambios
    </button>
</div>
</div>

<div class="row g-4">
    <!-- Editor Column -->
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0"><i class="bi bi-sliders"></i> Configuración</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="templateForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre de la Plantilla</label>
                        {{ form.title }}
                        <!-- Add bootstrap class manually if not in widget -->
                        <script>document.getElementById('id_title').classList.add('form-control');</script>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        {{ form.active }}
                        <label class="form-check-label" for="id_active">Plantilla Activa (Predeterminada)</label>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Logo de la Empresa</label>
                        {% if template.logo %}
                        <div class="mb-2">
                            <img src="{{ template.logo.url }}" alt="Logo actual" style="height: 50px;">
                        </div>
                        {% endif %}
                        {{ form.logo }}
                        <script>document.getElementById('id_logo').classList.add('form-control');</script>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">HTML Cabecera (Opcional)</label>
                        <div class="form-text mb-1">Reemplaza la cabecera por defecto. Usá HTML válido.</div>
                        {{ form.header_html }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">HTML Pie de Página (Opcional)</label>
                        {{ form.footer_html }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">CSS Personalizado</label>
                        <div class="form-text mb-1">Estilos CSS extra para ajustar colores, fuentes o márgenes.
                        </div>
                        {{ form.css }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Preview Column -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-eye"></i> Vista Previa en Vivo</h5>
                <button class="btn btn-sm btn-outline-secondary" id="refreshPreview">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
            </div>
            <div class="card-body p-0 bg-light d-flex justify-content-center align-items-center"
                style="min-height: 600px; overflow: hidden;">
                <div class="preview-container"
                    style="transform: scale(0.65); transform-origin: top center; margin-top: 20px;">
                    <iframe id="previewFrame"
                        src="{% url 'invoice_print_preview' %}?template_id={{ template.id|default:'' }}"
                        style="width: 210mm; height: 297mm; border: none; box-shadow: 0 0 20px rgba(0,0,0,0.15); background: white;">
                    </iframe>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('templateForm');
        const previewFrame = document.getElementById('previewFrame');
        const refreshBtn = document.getElementById('refreshPreview');

        // Function to reload preview
        function reloadPreview() {
            // In a real "live" preview without saving, we'd need to post the form data to the preview endpoint.
            // For now, we just reload the iframe to fetch the saved state, 
            // OR we could try to inject values if we want true client-side preview.

            // Simple reload for now (requires save first to see changes fully, 
            // unless we implement the POST preview logic mentioned in views.py)
            previewFrame.contentWindow.location.reload();
        }

        refreshBtn.addEventListener('click', reloadPreview);

        // Optional: Auto-save or warn on unsaved changes
        // For true live preview of CSS/HTML without saving, we would need to:
        // 1. Listen to input events on textareas.
        // 2. Post message to iframe with new content.
        // 3. Iframe script receives message and updates DOM.

        // Let's implement a basic CSS injector for the iframe
        const cssInput = document.getElementById('id_css');
        if (cssInput) {
            cssInput.addEventListener('input', function () {
                const css = this.value;
                const head = previewFrame.contentDocument.head;
                let style = previewFrame.contentDocument.getElementById('custom-preview-style');
                if (!style) {
                    style = previewFrame.contentDocument.createElement('style');
                    style.id = 'custom-preview-style';
                    head.appendChild(style);
                }
                style.textContent = css;
            });
        }
    });
</script>
{% endblock %}